<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Elatec Card Reader Test</title>
    <script src="/KioWare.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/site.css" rel="stylesheet">
    <link href="css/quicklinks.css" rel="stylesheet">
    <link href="css/custom.css" rel="stylesheet">
    <link href="KioskApp.styles.css" rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            background: #ffffff;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            background-color: #ffffff;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .login-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 800px;
        }

        .logo-section {
            margin-bottom: 3vh;
            text-align: center;
            width: 100%;
        }

        .logo-section img {
            max-height: 25vh;
            width: auto;
            object-fit: contain;
        }

        .instruction-text {
            margin-bottom: 2vh;
            text-align: center;
            background-color: transparent;
            font-size: calc(1rem + 1.5vw);
            width: auto;
            min-width: 90%;
            line-height: 1.3;
            font-weight: 500;
            white-space: nowrap;
            overflow: visible;
        }

        .input-section {
            width: 100%;
            max-width: 500px;
            margin-top: 2vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-field {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            height: 8vh;
            min-height: 60px;
            background-color: transparent;
            border-color: #dee2e6;
            font-size: calc(1rem + 0.8vw);
        }


        /* Media queries for different screen sizes */
        @media (min-width: 1920px) {
            .instruction-text {
                font-size: calc(1.2rem + 1.8vw);
            }

            .input-field,
            .submit-button,
            .submit-button i {
                font-size: calc(1.2rem + 1vw);
            }
        }

        @media (max-width: 768px) {
            .logo-section img {
                max-height: 20vh;
            }

            .instruction-text {
                font-size: calc(1rem + 2vw);
            }
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="login-content"><!--!-->
            <div class="logo-section"><img src="/beko_eu_white_background_one_line.png" alt="" class="img-fluid"></div>

            <!--!-->
            <div class="instruction-text">
                Avvicina il tuo badge al lettore per incominciare
            </div>
            <!--!-->
            <div class="instruction-text">
                Zbliż swoją plakietkę do czytnika, aby rozpocząć
            </div>
            <p id="redirectMessage" style="color: red; font-weight: bold;" class="instruction-text"></p>
            <!--
            <div class="input-section">
                <div class="input-group"><input type="tex" class="form-control input-field" placeholder="" autofocus=""
                        _bl_4133470e-4df4-4884-aaeb-88f1c20677e3="">
                    <button class="btn btn-primary submit-button" style="visibility: hidden;"><i
                            class="bi bi-arrow-right"></i></button>
                </div>
               !-->
        </div>
    </div>
    </div>


    <script>
        const deviceName = "Elatec_card_reader";
        // const functionResultInput = document.getElementById("functionResult");
        //const deviceDataInput = document.getElementById("deviceData");
        //const badgeIdInput = document.getElementById("badgeId");
        //const userIdInput = document.getElementById("userId");
        const redirectMessage = document.getElementById("redirectMessage");

        //Step 1: Configurable mapping object
        /* Removed local user mapping
        const badgeToUserMap = {
          "328271": "93601159",
          "123456": "user_abc",
          "999999": "user_xyz"
           //Add more mappings as needed
        };
        */

        function getReaderData() {

            const result = KioIdStorageTagDevice.GetData(deviceName);
            // functionResultInput.value = result;
        }

        // Step 2: Handle incoming data
        function OnKioDeviceData(deviceName, jsonData) {

            const jsonStr = JSON.stringify(jsonData);
            //deviceDataInput.value = jsonStr;

            try {
                const dataList = jsonData.DataList;
                if (Array.isArray(dataList) && dataList.length > 0) {
                    const badgeId = dataList[0].Data;
                    //badgeIdInput.value = badgeId;

                    // Step 3: Map badge to user ID
                    /*
                    const userId = badgeToUserMap[badgeId] || "UnknownUser";
                    userIdInput.value = userId;
                    */

                    // Set timeout, after 5 sec user is redirect to okta with userID as query string parameter
                    // redirectMessage.textContent = `Redirecting to Okta: ${badgeId}...`;
                    /* Original working code
                    setTimeout(() => {
                        const redirectUrl = `https://oktakioskredirect.beko.com/Default.aspx?BadgeID=${encodeURIComponent(badgeId)}`;
                        window.location.href = redirectUrl;
                    }, 500);
*/

                    setTimeout(() => {

                        // to be replaced with: https://oktakioskredirect.beko.com/Default.aspx?BadgeID=${encodeURIComponent(badgeId)}
                        const url = `https://oktakiosk.beko.com/pin-code-entry?badgeId=${encodeURIComponent(badgeId)}`;
                        fetch(url, { method: 'HEAD' }).then(response => {
                            if (response.ok) {
                                window.location.href = url;
                            } else {
                                redirectMessage.textContent = 'Badge non trovato - Nie znaleziono plakietki';
                                setTimeout(() => { redirectMessage.textContent = ''; }, 30000);
                            }
                        }).catch(() => {
                            redirectMessage.textContent = 'Problemi nella connessione al server - Problem z połączeniem z serwerem';
                            setTimeout(() => { redirectMessage.textContent = ''; }, 30000);
                        });
                    }, 500);

                } else {
                    //badgeIdInput.value = "No badge data found";
                    // userIdInput.value = "";
                    redirectMessage.textContent = "Problemi nella connessione al server - Problem z połączeniem z serwerem";
                    setTimeout(() => {
                        redirectMessage.textContent = '';
                    }, 30000);
                }
            } catch (err) {
                //badgeIdInput.value = "Error parsing data";
                //userIdInput.value = "";
                redirectMessage.textContent = "Error processing card data:" + err;
                console.error("Failed to process device data", err);
                setTimeout(() => {
                    redirectMessage.textContent = '';
                }, 30000);

            }
        }

    </script>
</body>

</html>
